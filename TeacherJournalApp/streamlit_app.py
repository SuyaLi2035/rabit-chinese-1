import streamlit as st
from openai import OpenAI
import os

# 👉 请把下面 Key 换成最终可用的 Key
client = OpenAI(
    base_url="https://tbnx.plus7.plus/v1",
    api_key="sk-nrhsBkVQttpJifie93GlhrmkdTTyi7zBE6a0UqeCs6TaxAYZ"
)

st.set_page_config(page_title="兔子老师课堂随笔生成器", page_icon="🐇")
st.title("🐇 我的可爱的兔子老师课堂随笔")

st.markdown("**上传 .txt 文件或直接粘贴课堂文字，然后点击生成随笔**")

uploaded_txt = st.file_uploader("上传课堂文字文件 (.txt)", type=["txt"])
text_input = st.text_area("或粘贴课堂文字👇", height=200)

# 固定模型为 gpt-4o，不提供选择
model_name = "gpt-4o"
st.markdown("🌟 当前使用模型：**gpt-4o**")


if st.button("生成随笔"):
    # ① 获取内容
    content = ""
    if uploaded_txt is not None:
        content = uploaded_txt.read().decode("utf-8", errors="ignore")
    if not content:
        content = text_input.strip()
    if not content:
        st.error("请上传 txt 文件或粘贴文字！")
        st.stop()

    # ② 组织提示词
    prompt = f"""这是我的案例课堂随笔：
        年的余味还在心头，孩子们带着满满的能量和全新的目标走进教室。让我们用饱满的热情拥抱新的阅读旅程。
       孩子们在教室里来回踱步，眉飞色舞的讲诉起自己寒假所发生的事情～～
        杨一：“我过年的时候在家做作业，还出去吃大餐🍛。”
        恩萁：“我去看了哪吒的电影。”
        梓潼：“我去打卡了泉州的蛇🐍。”
        骐毓：“我和好朋友一起去泉港玩，吃美食，放鞭炮。”
                    ……
        在这次的寒假趣事分享中，大家带来了各自丰富多彩的经历，让我们仿佛一同度过了一个精彩纷呈的假期。随着上课歌声的响起，接下来我们一起在阅读的海洋中尽情遨游，共同追逐梦想的光芒吧！
东涂大C
兔子老师
2025.2.15

课堂随笔：
        在绘本《树真好》中，孩子们在树上玩耍、人们在树荫下乘凉休息、鸟儿🦅在树上栖息。树🌳不仅为人类提供了清新的空气、美丽的风景，还为各种生物创造了栖息之所，是大自然给予的珍贵礼物。
        🌳杨一：“树真好，不还可以当装饰在上面挂上五颜六色的灯。”
        🌳涵钰：“树真好，可以让我们在上面荡秋千。”
        🌳骐毓：“树真好，树还可以遮住阳光，让我们更加的凉爽。”
        🌳梓瞳：“树真好，大树可以帮我们净化空气。”
        🌳皓然：“树真好，因为大树绿油油的能让人心情变得很好。”
                   ……
        绘本中展现了树对生态平衡的重要作用，然而现实中，由于人类的过度开发和砍伐🪵，许多树木正在消失，生态环境面临着严峻的挑战。我们每个人都有责任保护树木，爱护大自然。从我们做起，从小事做起。让我们共同努力，让树继续在地球上茁壮成长！
东涂大C
兔子老师
2025.2.22

课堂随笔：
       在阅读绘本《故宫里的汉字——保卫紫禁城》中，孩子们仿佛开启了一场穿越时空的奇妙冒险。一起了解紫禁城三大防御系统。
        恩萁：“有护城河可以保护故宫。”
        杨一：“还有高高的城墙。”
        章宽：“故宫的每个角都有角楼。”
        涵钰：“还有很少的门。”
                   ……
        这本绘本就像一把神奇的钥匙🔑，打开了孩子对紫禁城与古建筑文化热爱的大门🚪，让孩子们迫不及待地想要探索更多其中的奥秘。有机会可以去亲眼看看紫禁城，让孩子为大朋友介绍哟！
东涂大C
兔子老师
2025.3.1

课堂随笔：
        打开绘本《阴天有时下肉丸》故事中有一个小镇——吧唧吧唧小镇。从外观上，它和常见的小镇并无差别，可内里却隐藏着一个惊人秘密：这里没有售卖食物的商店，人们的食物来源竟然是天空。
       这一消息瞬间点燃了孩子们的好奇心，他们的表情从平静转为惊叹，眼睛瞪得大大的。
       杨一：“天上会掉鸡蛋🥚和馅饼🌯。”
       恩萁：“从天上会掉下来不同的水果🍓。”
       骐毓：“我觉得从天上会掉下很多的蔬菜🥦🥬。”
       皓然：“从天上应该会掉下来很多鸡腿🍗。”
       若妤：“能从天上会掉下来很多水果🍑和蔬菜🥦。”
       梓潼：“我也认为是很多的蔬菜和水果🍍。”
                    ……
       吧唧吧唧小镇一开始，确实像是上天赐予居民的一份厚礼，人们尽情沉醉在这场美食盛宴中，尽情享用肉丸、薯条等美味。然而，随着时间的流逝，天气出现异常🌪，破坏了小镇原本的样子，人们的生活也因此受到严重影响，陷入了困境。小镇的人们只好前往了另一座小镇，他们的生活有什么变化呢？我们下节课一起来分享吧！
东涂大C
兔子老师
2025.3.8，请你模仿“东涂大C 兔子老师”的课堂随笔风格：

有情境、有温度、有孩子原话（带表情符号）；

结尾升华主题，引导思考；

字数控制在300-500字左右；

保持亲切、童趣和教育引导的氛围；

最后落款格式：东涂大C / 兔子老师 / [当天日期]。。

课堂内容：
{content}
"""

    # ③ 调用接口
    with st.spinner("✏️ 正在生成随笔..."):
        try:
            resp = client.chat.completions.create(
                model=model_name,
                messages=[
                    {"role": "system", "content": "你是一位小学语文老师，擅长撰写有温度的课堂随笔"},
                    {"role": "user", "content": prompt}
                ],
                timeout=60   # ← 新版 SDK 正确写法
            )
            essay = resp.choices[0].message.content.strip()
            st.success("🎉 随笔生成成功")
            st.markdown(essay)
            st.download_button(
                "📥 下载随笔",
                essay.encode("utf-8"),
                file_name="课堂随笔.txt"
            )
        except Exception as e:
            st.error(f"生成失败：{e}")
